;-------------------------------------------------
;兵の要求の処理
;ARG:0は相手の勢力番号、ARG:1は要求の重さ。要求を飲むと1、断ると0を返す
;-------------------------------------------------
@DIPLOMACTY_REQUESTED_SOLDIER(ARG:0, ARG:1)
;相手勢力の君主のキャラ番号を取得
LOCAL:5 = GET_COUNTRY_BOSS(ARG:0)

LOCAL:12 = GET_SUM_SOLDIER(CFLAG:MASTER:所属)
LOCAL:13 = GET_SUM_ARMY_DF(CFLAG:MASTER:所属)
IF ARG:1 == 0
	LOCAL:11 = MIN(GET_SUM_ECONOMY(CFLAG:MASTER:所属) * 3 / 1000, LOCAL:12 / 2)
ELSEIF ARG:1 == 1
	LOCAL:11 = MIN(GET_SUM_ECONOMY(CFLAG:MASTER:所属) * 8 / 1000, LOCAL:12 * 2 / 3)
ELSE
	LOCAL:11 = MIN(GET_SUM_ECONOMY(CFLAG:MASTER:所属) * 20 / 1000, LOCAL:12)
ENDIF
PRINTFORML %ANAME(LOCAL:5)%は、こちらの提案を飲む代わりに兵{LOCAL:11}を要求してきた
PRINTFORML 現在の総兵数:{LOCAL:12}(うち未割当兵数:{COUNTRY_SOLDIER:(CFLAG:MASTER:所属)})
IF LOCAL:11 > COUNTRY_SOLDIER:(CFLAG:MASTER:所属)
	IF LOCAL:11 > COUNTRY_SOLDIER:(CFLAG:MASTER:所属) + LOCAL:13
		PRINTFORML ※要求兵数が現在の未割当兵数より多いため、全部隊を解散し、防衛に着いている兵も渡す必要があります
	ELSE
		PRINTFORML ※要求兵数が現在の未割当兵数より多いため、防衛に着いている兵も渡す必要があります
	ENDIF
ENDIF
WAIT
CALL ASK_YN("受け入れる", "断る")
IF RESULT != 0
	RETURN 0
ENDIF

IF LOCAL:11 > COUNTRY_SOLDIER:(CFLAG:MASTER:所属)
	IF LOCAL:11 > COUNTRY_SOLDIER:(CFLAG:MASTER:所属) + LOCAL:13
		CALL CLEAR_ALL_UNIT(CFLAG:MASTER:所属)
	ENDIF

	FOR LOCAL:0, 0, MAX_CITY
		IF CITY_OWNER:(LOCAL:0) == CFLAG:MASTER:所属
			COUNTRY_SOLDIER:(CFLAG:MASTER:所属) += CITY_SOLDIER:(LOCAL:0)
			CITY_SOLDIER:(LOCAL:0) = 0
		ENDIF
	NEXT

	COUNTRY_SOLDIER:(CFLAG:MASTER:所属) = MAX(COUNTRY_SOLDIER:(CFLAG:MASTER:所属) - LOCAL:11, 0)

	FOR LOCAL:0, 0, MAX_CITY
		IF CITY_OWNER:(LOCAL:0) == CFLAG:MASTER:所属
			LOCAL:15 = MIN(COUNTRY_SOLDIER:(CFLAG:MASTER:所属), 500)
			CITY_SOLDIER:(LOCAL:0) += LOCAL:15
			COUNTRY_SOLDIER:(CFLAG:MASTER:所属) -= LOCAL:15
		ENDIF
	NEXT

ELSE
	COUNTRY_SOLDIER:(CFLAG:MASTER:所属) = MAX(COUNTRY_SOLDIER:(CFLAG:MASTER:所属) - LOCAL:11, 0)
ENDIF

COUNTRY_SOLDIER:(ARG:0) += LOCAL:11

RETURN 1

